<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>占卜结果 - 梅花心易</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/starry-theme.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e3a8a',
                        secondary: '#fbbf24',
                        dark: '#0f172a',
                        mystic: '#312e81',
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%);
        }
        .card-appear {
            animation: cardAppear 0.8s ease-out forwards;
            opacity: 0;
            transform: translateY(30px);
        }
        @keyframes cardAppear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .hexagram-line {
            transition: all 0.3s ease;
        }
        .hexagram-line:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
        }
        .floating-element {
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body class="starry-bg min-h-screen">
    <!-- 星座装饰元素 -->
    <div class="constellation-decoration"></div>

    <!-- 星盘装饰圆环 -->
    <div class="astral-ring astral-ring-1"></div>
    <div class="astral-ring astral-ring-2"></div>

    <!-- 星座符号装饰 -->
    <div class="zodiac-symbol">♈</div>
    <div class="zodiac-symbol">♌</div>
    <div class="zodiac-symbol">♐</div>
    <div class="zodiac-symbol">♓</div>

    <!-- 状态栏 -->
    <div class="h-11 bg-black"></div>

    <!-- 顶部导航 -->
    <div class="starry-bg px-6 py-4 relative z-10">
        <div class="flex items-center justify-between">
            <button onclick="window.location.href='home.html'" class="mystical-text-accent hover:scale-110 transition-transform">
                <i class="fas fa-home text-xl cosmic-glow"></i>
            </button>
            <h1 class="mystical-text font-semibold text-lg">✦ 占卜结果 ✦</h1>
            <button onclick="showActionsModal()" class="mystical-text-accent hover:scale-110 transition-transform">
                <i class="fas fa-ellipsis-v text-xl cosmic-glow"></i>
            </button>
        </div>
    </div>

    <!-- 主要内容 -->
    <div class="px-6 py-6 pb-24 relative z-10">
        <!-- 问题回顾 - 星空神秘主题 -->
        <div class="card-appear mb-6" style="animation-delay: 0.1s;">
            <div class="mystical-card rounded-2xl p-4 starlight-border relative overflow-hidden">
                <!-- 装饰星光 -->
                <div class="absolute top-2 right-2 text-yellow-300/40">
                    <i class="fas fa-question-circle text-xs"></i>
                </div>

                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-400/30 to-indigo-500/30 rounded-full flex items-center justify-center flex-shrink-0 mt-1 cosmic-glow">
                        <i class="fas fa-question mystical-text-accent text-sm"></i>
                    </div>
                    <div>
                        <h3 class="font-medium mystical-text mb-1 flex items-center">
                            <i class="fas fa-star mr-2 mystical-text-accent text-xs"></i>
                            您的问题
                        </h3>
                        <p class="mystical-text-secondary text-sm leading-relaxed">
                            我在考虑是否应该接受这个新的工作机会，这个职位薪资更高但需要搬到另一个城市，离开现在的朋友圈...
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 卦象展示 - 星空神秘主题 -->
        <div class="card-appear mb-6" style="animation-delay: 0.2s;">
            <div class="mystical-card rounded-2xl p-6 starlight-border relative overflow-hidden" style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);">
                <!-- 装饰星光 -->
                <div class="absolute top-3 right-3 text-yellow-300/50">
                    <i class="fas fa-yin-yang text-lg cosmic-glow"></i>
                </div>
                <div class="absolute bottom-3 left-3 text-yellow-300/30">
                    <i class="fas fa-star text-xs"></i>
                </div>

                <div class="text-center mb-4">
                    <h2 class="text-xl font-bold mystical-text mb-2 flex items-center justify-center">
                        <i class="fas fa-scroll mr-2 mystical-text-accent"></i>
                        得卦：天火同人
                        <i class="fas fa-scroll ml-2 mystical-text-accent"></i>
                    </h2>
                    <p class="mystical-text-secondary text-sm">✧ 本卦 → 变卦：天火同人 → 天山遁 ✧</p>
                </div>
                
                <!-- 卦象图 - 星空神秘主题 -->
                <div class="flex justify-center space-x-8 mb-4">
                    <!-- 本卦 -->
                    <div class="text-center">
                        <h4 class="text-sm font-medium mystical-text mb-3 flex items-center justify-center">
                            <i class="fas fa-sun mr-1 mystical-text-accent text-xs"></i>
                            本卦
                        </h4>
                        <div class="space-y-1 p-2 bg-black/10 rounded-lg">
                            <div class="hexagram-line bg-gradient-to-r from-yellow-400 to-yellow-500 h-1 w-12 rounded mx-auto cosmic-glow"></div>
                            <div class="hexagram-line bg-gradient-to-r from-yellow-400 to-yellow-500 h-1 w-12 rounded mx-auto cosmic-glow"></div>
                            <div class="hexagram-line flex space-x-1 justify-center">
                                <div class="bg-gradient-to-r from-yellow-400 to-yellow-500 h-1 w-5 rounded cosmic-glow"></div>
                                <div class="bg-gradient-to-r from-yellow-400 to-yellow-500 h-1 w-5 rounded cosmic-glow"></div>
                            </div>
                            <div class="hexagram-line bg-gradient-to-r from-yellow-400 to-yellow-500 h-1 w-12 rounded mx-auto cosmic-glow"></div>
                            <div class="hexagram-line flex space-x-1 justify-center">
                                <div class="bg-gradient-to-r from-yellow-400 to-yellow-500 h-1 w-5 rounded cosmic-glow"></div>
                                <div class="bg-gradient-to-r from-yellow-400 to-yellow-500 h-1 w-5 rounded cosmic-glow"></div>
                            </div>
                            <div class="hexagram-line bg-gradient-to-r from-yellow-400 to-yellow-500 h-1 w-12 rounded mx-auto cosmic-glow"></div>
                        </div>
                        <p class="text-xs mystical-text-secondary mt-2">天火同人</p>
                    </div>

                    <!-- 箭头 -->
                    <div class="flex items-center">
                        <i class="fas fa-arrow-right mystical-text-accent text-xl floating-element cosmic-glow"></i>
                    </div>

                    <!-- 变卦 -->
                    <div class="text-center">
                        <h4 class="text-sm font-medium mystical-text mb-3 flex items-center justify-center">
                            <i class="fas fa-mountain mr-1 mystical-text-accent text-xs"></i>
                            变卦
                        </h4>
                        <div class="space-y-1 p-2 bg-black/10 rounded-lg">
                            <div class="hexagram-line bg-gradient-to-r from-gray-300 to-gray-400 h-1 w-12 rounded mx-auto"></div>
                            <div class="hexagram-line bg-gradient-to-r from-gray-300 to-gray-400 h-1 w-12 rounded mx-auto"></div>
                            <div class="hexagram-line bg-gradient-to-r from-gray-300 to-gray-400 h-1 w-12 rounded mx-auto"></div>
                            <div class="hexagram-line bg-gradient-to-r from-gray-300 to-gray-400 h-1 w-12 rounded mx-auto"></div>
                            <div class="hexagram-line flex space-x-1 justify-center">
                                <div class="bg-gradient-to-r from-gray-300 to-gray-400 h-1 w-5 rounded"></div>
                                <div class="bg-gradient-to-r from-gray-300 to-gray-400 h-1 w-5 rounded"></div>
                            </div>
                            <div class="hexagram-line bg-gradient-to-r from-gray-300 to-gray-400 h-1 w-12 rounded mx-auto"></div>
                        </div>
                        <p class="text-xs mystical-text-secondary mt-2">天山遁</p>
                    </div>
                </div>

                <!-- 卦象基本信息 - 星空神秘主题 -->
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div class="mystical-card p-3 rounded-lg">
                        <p class="text-xs mystical-text-secondary">卦象</p>
                        <p class="font-medium mystical-text-accent">同人</p>
                    </div>
                    <div class="mystical-card p-3 rounded-lg">
                        <p class="text-xs mystical-text-secondary">五行</p>
                        <p class="font-medium mystical-text-accent">火天</p>
                    </div>
                    <div class="mystical-card p-3 rounded-lg">
                        <p class="text-xs mystical-text-secondary">吉凶</p>
                        <p class="font-medium text-green-400 cosmic-glow">中吉</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI解读 - 星空神秘主题 -->
        <div class="card-appear mb-6" style="animation-delay: 0.3s;">
            <div class="mystical-card rounded-2xl p-6 starlight-border relative overflow-hidden">
                <!-- 装饰星光 -->
                <div class="absolute top-3 right-3 text-purple-300/50">
                    <i class="fas fa-brain text-lg cosmic-glow"></i>
                </div>
                <div class="absolute bottom-3 left-3 text-purple-300/30">
                    <i class="fas fa-sparkles text-xs"></i>
                </div>

                <div class="flex items-center space-x-3 mb-4">
                    <div class="w-10 h-10 bg-gradient-to-br from-purple-400/30 to-indigo-500/30 rounded-full flex items-center justify-center cosmic-glow">
                        <i class="fas fa-robot mystical-text-accent"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold mystical-text flex items-center">
                            <i class="fas fa-star mr-2 mystical-text-accent text-sm"></i>
                            AI智能解读
                        </h3>
                        <p class="text-xs mystical-text-secondary">✧ 基于梅花易数传统理论 ✧</p>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <!-- 总体运势 -->
                    <div>
                        <h4 class="font-medium mystical-text mb-2 flex items-center">
                            <i class="fas fa-star mystical-text-accent mr-2 cosmic-glow"></i>
                            ✧ 总体运势 ✧
                        </h4>
                        <p class="mystical-text-secondary text-sm leading-relaxed">
                            天火同人卦象显示，您当前面临的选择具有积极的发展潜力。"同人"代表与人和谐相处，暗示新环境中将遇到志同道合的伙伴。虽然需要离开熟悉的环境，但这种改变将为您带来更广阔的发展空间。
                        </p>
                    </div>

                    <!-- 具体建议 -->
                    <div>
                        <h4 class="font-medium mystical-text mb-2 flex items-center">
                            <i class="fas fa-lightbulb mystical-text-accent mr-2 cosmic-glow"></i>
                            ✧ 具体建议 ✧
                        </h4>
                        <div class="space-y-2">
                            <div class="flex items-start space-x-2">
                                <div class="w-2 h-2 bg-green-400 rounded-full mt-2 flex-shrink-0 cosmic-glow"></div>
                                <p class="mystical-text-secondary text-sm">建议接受这个工作机会，时机较为有利</p>
                            </div>
                            <div class="flex items-start space-x-2">
                                <div class="w-2 h-2 bg-blue-400 rounded-full mt-2 flex-shrink-0 cosmic-glow"></div>
                                <p class="mystical-text-secondary text-sm">搬迁过程中要保持开放心态，主动建立新的人际关系</p>
                            </div>
                            <div class="flex items-start space-x-2">
                                <div class="w-2 h-2 bg-purple-400 rounded-full mt-2 flex-shrink-0 cosmic-glow"></div>
                                <p class="mystical-text-secondary text-sm">与现有朋友保持联系，距离不会影响真正的友谊</p>
                            </div>
                        </div>
                    </div>

                    <!-- 注意事项 -->
                    <div>
                        <h4 class="font-medium mystical-text mb-2 flex items-center">
                            <i class="fas fa-exclamation-triangle text-orange-400 mr-2 cosmic-glow"></i>
                            ✧ 注意事项 ✧
                        </h4>
                        <p class="mystical-text-secondary text-sm leading-relaxed">
                            变卦天山遁提醒您，在新环境中要保持谦逊低调，避免过于张扬。初期可能会有适应困难，但坚持下去必有收获。建议在做最终决定前，详细了解新工作的具体要求和发展前景。
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 时间建议 - 星空神秘主题 -->
        <div class="card-appear mb-6" style="animation-delay: 0.4s;">
            <div class="mystical-card rounded-2xl p-4 starlight-border relative overflow-hidden" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(99, 102, 241, 0.05) 100%);">
                <!-- 装饰星光 -->
                <div class="absolute top-2 right-2 text-blue-300/40">
                    <i class="fas fa-clock text-xs"></i>
                </div>

                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-400/30 to-indigo-500/30 rounded-full flex items-center justify-center cosmic-glow">
                        <i class="fas fa-calendar-alt mystical-text-accent"></i>
                    </div>
                    <div>
                        <h3 class="font-medium mystical-text flex items-center">
                            <i class="fas fa-hourglass-half mr-2 mystical-text-accent text-sm"></i>
                            最佳时机
                        </h3>
                        <p class="mystical-text-secondary text-sm">✧ 建议在本月下旬做出最终决定，下个月初开始行动 ✧</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 占卜信息 - 星空神秘主题 -->
        <div class="card-appear" style="animation-delay: 0.5s;">
            <div class="mystical-card rounded-xl p-4 text-center starlight-border">
                <div class="flex items-center justify-center space-x-4 text-xs mystical-text-secondary">
                    <span class="flex items-center">
                        <i class="fas fa-clock mr-1 mystical-text-accent"></i>
                        占卜时间：2025-01-26 14:30
                    </span>
                    <span class="mystical-text-accent">✦</span>
                    <span class="flex items-center">
                        <i class="fas fa-dice mr-1 mystical-text-accent"></i>
                        消耗次数：1次
                    </span>
                    <span class="mystical-text-accent">✦</span>
                    <span class="flex items-center">
                        <i class="fas fa-moon mr-1 mystical-text-accent"></i>
                        剩余：7次
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部操作栏 - 星空神秘主题 -->
    <div class="fixed bottom-0 left-0 right-0 mystical-card border-t starlight-border px-6 py-4 z-20">
        <div class="flex space-x-3">
            <button onclick="window.location.href='question-input.html'"
                    class="mystical-btn flex-1 py-3 text-primary font-semibold rounded-xl">
                <i class="fas fa-redo mr-2"></i>
                ✦ 再次占卜 ✦
            </button>
            <button onclick="shareResult()"
                    class="mystical-card px-6 py-3 mystical-text font-semibold rounded-xl starlight-border hover:scale-105 transition-transform">
                <i class="fas fa-share-alt mystical-text-accent cosmic-glow"></i>
            </button>
            <button onclick="saveResult()"
                    class="mystical-card px-6 py-3 mystical-text font-semibold rounded-xl starlight-border hover:scale-105 transition-transform">
                <i class="fas fa-bookmark mystical-text-accent cosmic-glow"></i>
            </button>
        </div>
    </div>

    <!-- 引入应用核心脚本 -->
    <script src="js/app-state.js"></script>
    <script src="js/router.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/app-core.js"></script>

    <script>
        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            initDivinationResult();
        });

        function initDivinationResult() {
            if (window.app && window.app.isInitialized) {
                setupEventListeners();
                checkAuthStatus();
                loadDivinationResult();
                initPageAnimations();
            } else {
                setTimeout(initDivinationResult, 100);
            }
        }

        function checkAuthStatus() {
            // 检查是否已登录
            const isLoggedIn = window.appState.getState('user.isLoggedIn');
            if (!isLoggedIn) {
                window.router.navigate('login');
                return;
            }
        }

        function loadDivinationResult() {
            // 加载当前占卜结果
            const currentResult = window.appState.getState('session.currentResult');
            const currentQuestion = window.appState.getState('session.currentQuestion');

            if (!currentResult || !currentQuestion) {
                // 如果没有结果，重定向到首页
                window.Utils.showToast('未找到占卜结果', 'warning');
                window.router.navigate('home');
                return;
            }

            // 更新页面内容
            updateResultDisplay(currentQuestion, currentResult);
            updateFreeCountDisplay();
        }

        function updateResultDisplay(question, result) {
            // 更新问题显示
            const questionElement = document.querySelector('.text-gray-600.text-sm.leading-relaxed');
            if (questionElement) {
                questionElement.textContent = question;
            }

            // 更新卦象信息
            const hexagramName = document.querySelector('.text-xl.font-bold.text-gray-800');
            if (hexagramName && result.hexagram) {
                hexagramName.textContent = `得卦：${result.hexagram.name}`;
            }

            // 更新卦象基本信息
            const infoElements = document.querySelectorAll('.font-medium.text-gray-800');
            if (infoElements.length >= 3 && result.hexagram) {
                infoElements[1].textContent = result.hexagram.type;
                infoElements[2].textContent = result.hexagram.element;
            }

            const fortuneElement = document.querySelector('.font-medium.text-green-600');
            if (fortuneElement && result.hexagram) {
                fortuneElement.textContent = result.hexagram.fortune;
            }

            // 更新AI解读内容
            const interpretationElement = document.querySelector('.text-gray-700.text-sm.leading-relaxed');
            if (interpretationElement) {
                interpretationElement.textContent = result.interpretation;
            }

            // 更新建议内容
            const adviceElement = document.querySelector('.space-y-2 .text-gray-700.text-sm');
            if (adviceElement) {
                adviceElement.textContent = result.advice || '建议您结合实际情况，理性分析，做出最适合自己的决定。';
            }

            // 更新时间建议
            const timingElement = document.querySelector('.text-gray-600.text-sm');
            if (timingElement) {
                timingElement.textContent = result.timing || '建议在本月下旬做出最终决定，下个月初开始行动';
            }
        }

        function updateFreeCountDisplay() {
            const freeCount = window.appState.getState('app.freeCount');
            const freeCountElement = document.querySelector('.text-xs.text-gray-500 span:last-child');
            if (freeCountElement) {
                freeCountElement.textContent = `剩余：${freeCount}次`;
            }
        }

        function setupEventListeners() {
            // 返回首页按钮
            document.querySelector('.fa-home').parentElement.addEventListener('click', function(e) {
                e.preventDefault();
                window.router.navigate('home');
            });

            // 更多操作按钮
            document.querySelector('.fa-ellipsis-v').parentElement.addEventListener('click', function(e) {
                e.preventDefault();
                showActionsModal();
            });

            // 再次占卜按钮
            const againBtn = Array.from(document.querySelectorAll('button')).find(btn => btn.textContent.includes('再次占卜'));
            if (againBtn) {
                againBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.router.navigate('question-input');
                });
            }

            // 分享按钮
            const shareBtn = document.querySelector('.fa-share-alt').parentElement;
            if (shareBtn) {
                shareBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    shareResult();
                });
            }

            // 保存按钮
            const saveBtn = document.querySelector('.fa-bookmark').parentElement;
            if (saveBtn) {
                saveBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    saveResult();
                });
            }
        }

        function showActionsModal() {
            // 跳转到操作选择弹窗
            window.router.navigate('result-actions-modal');
        }

        async function shareResult() {
            try {
                const success = await window.app.shareResult();
                if (success) {
                    updateFreeCountDisplay();
                }
            } catch (error) {
                window.Utils.showToast('分享失败', 'error');
            }
        }

        function saveResult() {
            // 结果已经在生成时保存到历史记录了
            window.Utils.showToast('占卜结果已保存到历史记录', 'success');
        }

        // 页面加载动画
        function initPageAnimations() {
            // 卡片出现动画
            const cards = document.querySelectorAll('.card-appear');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(30px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.8s ease-out';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 200);
            });

            // 卦象线条动画
            const hexagramLines = document.querySelectorAll('.hexagram-line');
            hexagramLines.forEach((line, index) => {
                line.style.animationDelay = `${0.6 + index * 0.1}s`;
                line.classList.add('card-appear');
            });
        }

        // 监听状态变化
        window.addEventListener('stateChange', function(e) {
            const { path } = e.detail;
            if (path === 'app.freeCount') {
                updateFreeCountDisplay();
            }
        });

        // 防止意外返回（仅在用户未交互时）
        let hasInteracted = false;
        document.addEventListener('click', () => hasInteracted = true);

        window.addEventListener('beforeunload', function(e) {
            if (!hasInteracted) {
                e.preventDefault();
                e.returnValue = '确定要离开占卜结果页面吗？';
            }
        });
    </script>
</body>
</html>
