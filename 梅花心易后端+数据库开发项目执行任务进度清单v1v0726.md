# 梅花心易后端+数据库开发项目执行任务进度清单 v1.0 (2025-07-26)

## 📋 项目概述

### 项目信息
- **项目名称**: 梅花心易占卜应用后端+数据库
- **技术栈**: Node.js + Express.js + MongoDB + Redis
- **开发周期**: 3天MVP + 2周Beta版本
- **部署方式**: Sealos DevBox
- **API设计**: RESTful API + JWT认证

### 架构设计
- **后端框架**: Express.js + TypeScript
- **数据库**: MongoDB (主数据库) + Redis (缓存)
- **认证方式**: JWT Token + BCrypt密码加密
- **AI服务**: Claude 3.7 Sonnet API
- **文件存储**: 本地存储 + 云存储(可选)
- **消息队列**: Redis (处理异步任务)

## 🏗️ 第一阶段：项目初始化与基础架构 (Day 1上午)

### ✅ 任务1.1：项目环境搭建
- [ ] **1.1.1** 创建Node.js项目
  ```bash
  mkdir meihua-backend
  cd meihua-backend
  npm init -y
  npm install express mongoose redis jsonwebtoken bcryptjs
  npm install cors helmet morgan compression dotenv
  npm install -D nodemon typescript @types/node @types/express
  ```

- [ ] **1.1.2** TypeScript配置
  - 配置tsconfig.json
  - 设置编译脚本
  - 配置开发环境热重载
  - 设置代码格式化规则

- [ ] **1.1.3** 项目目录结构
  ```
  src/
  ├── controllers/        # 控制器层
  │   ├── auth.controller.js
  │   ├── user.controller.js
  │   └── divination.controller.js
  ├── models/            # 数据模型
  │   ├── User.js
  │   ├── Divination.js
  │   └── Payment.js
  ├── routes/            # 路由定义
  │   ├── auth.routes.js
  │   ├── user.routes.js
  │   └── divination.routes.js
  ├── middleware/        # 中间件
  │   ├── auth.middleware.js
  │   ├── validation.middleware.js
  │   └── error.middleware.js
  ├── services/          # 业务逻辑层
  │   ├── auth.service.js
  │   ├── divination.service.js
  │   └── ai.service.js
  ├── utils/             # 工具函数
  │   ├── database.js
  │   ├── redis.js
  │   └── helpers.js
  ├── config/            # 配置文件
  │   ├── database.config.js
  │   └── app.config.js
  └── app.js             # 应用入口
  ```

### ✅ 任务1.2：数据库设计与连接
- [ ] **1.2.1** MongoDB数据库设计
  ```javascript
  // 用户模型 (User)
  {
    _id: ObjectId,
    email: String (unique, required),
    password: String (hashed, required),
    nickname: String,
    avatar: String,
    gender: String (enum: ['male', 'female', 'other']),
    birthDate: Date,
    freeCount: Number (default: 10),
    totalCount: Number (default: 0),
    isActive: Boolean (default: true),
    lastLoginAt: Date,
    createdAt: Date,
    updatedAt: Date
  }

  // 占卜记录模型 (Divination)
  {
    _id: ObjectId,
    userId: ObjectId (ref: 'User'),
    question: String (required),
    hexagram: {
      original: Object,    // 本卦
      changed: Object,     // 变卦
      lines: Array,        // 爻辞
      interpretation: String
    },
    aiInterpretation: {
      overall: String,     // 总体运势
      advice: Array,       // 具体建议
      warning: String,     // 注意事项
      timing: String       // 时机建议
    },
    status: String (enum: ['pending', 'completed', 'failed']),
    isPaid: Boolean (default: false),
    createdAt: Date
  }

  // 支付记录模型 (Payment)
  {
    _id: ObjectId,
    userId: ObjectId (ref: 'User'),
    amount: Number,
    count: Number,        // 购买次数
    paymentMethod: String,
    transactionId: String,
    status: String (enum: ['pending', 'completed', 'failed']),
    createdAt: Date
  }
  ```

- [ ] **1.2.2** 数据库连接配置
  - 配置MongoDB连接
  - 设置连接池参数
  - 实现连接错误处理
  - 配置数据库索引

- [ ] **1.2.3** Redis缓存配置
  - 配置Redis连接
  - 设计缓存策略
  - 实现缓存工具函数
  - 配置缓存过期策略

### ✅ 任务1.3：基础中间件配置
- [ ] **1.3.1** 安全中间件
  - 配置CORS跨域
  - 设置Helmet安全头
  - 实现请求限流
  - 配置请求体大小限制

- [ ] **1.3.2** 日志中间件
  - 配置Morgan访问日志
  - 实现错误日志记录
  - 设置日志轮转
  - 配置不同环境日志级别

- [ ] **1.3.3** 验证中间件
  - 实现请求参数验证
  - 配置数据格式检查
  - 实现敏感词过滤
  - 设置请求频率限制

## 🔐 第二阶段：用户认证系统 (Day 1下午)

### ✅ 任务2.1：认证API开发
- [ ] **2.1.1** 用户注册API
  ```javascript
  POST /api/auth/register
  Body: {
    email: string,
    password: string,
    nickname?: string
  }
  Response: {
    success: boolean,
    message: string,
    data: {
      user: UserInfo,
      token: string
    }
  }
  ```

- [ ] **2.1.2** 邮箱验证API
  ```javascript
  POST /api/auth/send-verification
  Body: { email: string }
  
  POST /api/auth/verify-email
  Body: { email: string, code: string }
  ```

- [ ] **2.1.3** 用户登录API
  ```javascript
  POST /api/auth/login
  Body: {
    email: string,
    password: string,
    rememberMe?: boolean
  }
  Response: {
    success: boolean,
    data: {
      user: UserInfo,
      token: string,
      refreshToken: string
    }
  }
  ```

- [ ] **2.1.4** Token管理API
  ```javascript
  POST /api/auth/refresh-token
  POST /api/auth/logout
  GET /api/auth/verify-token
  ```

### ✅ 任务2.2：认证服务实现
- [ ] **2.2.1** 密码加密服务
  - 实现BCrypt密码哈希
  - 设置盐值轮数 (12轮)
  - 实现密码强度验证
  - 添加密码重置功能

- [ ] **2.2.2** JWT Token服务
  - 实现Token生成和验证
  - 配置Token过期时间
  - 实现RefreshToken机制
  - 添加Token黑名单功能

- [ ] **2.2.3** 邮件验证服务
  - 集成邮件发送服务
  - 实现验证码生成
  - 设置验证码过期机制
  - 添加发送频率限制

### ✅ 任务2.3：用户管理API
- [ ] **2.3.1** 用户信息API
  ```javascript
  GET /api/user/profile      // 获取用户信息
  PUT /api/user/profile      // 更新用户信息
  POST /api/user/avatar      // 上传头像
  GET /api/user/stats        // 用户统计信息
  ```

- [ ] **2.3.2** 免费次数管理
  - 实现次数扣减逻辑
  - 添加次数查询接口
  - 实现次数重置机制
  - 添加次数使用记录

## 🔮 第三阶段：占卜核心系统 (Day 2)

### ✅ 任务3.1：梅花易数算法实现
- [ ] **3.1.1** 核心算法服务
  ```javascript
  // 梅花易数算法核心
  class MeiHuaAlgorithm {
    // 根据问题生成卦象
    generateHexagram(question, timestamp)
    
    // 计算本卦和变卦
    calculateHexagrams(upperGua, lowerGua, changeLines)
    
    // 解析卦象含义
    interpretHexagram(hexagram)
    
    // 生成占卜结果
    generateDivinationResult(question, hexagram)
  }
  ```

- [ ] **3.1.2** 卦象数据库
  - 创建64卦基础数据
  - 实现卦象查询服务
  - 添加爻辞数据
  - 配置卦象关系映射

- [ ] **3.1.3** 算法优化
  - 实现算法结果缓存
  - 添加算法性能监控
  - 优化计算效率
  - 实现算法版本管理

### ✅ 任务3.2：AI解读服务
- [ ] **3.2.1** Claude API集成
  ```javascript
  class AIService {
    // 生成AI解读
    async generateInterpretation(question, hexagram)
    
    // 格式化解读结果
    formatInterpretation(rawResponse)
    
    // 处理API错误和重试
    handleAPIError(error)
    
    // 实现请求限流
    rateLimitRequest()
  }
  ```

- [ ] **3.2.2** 提示词工程
  - 设计专业的提示词模板
  - 实现上下文管理
  - 添加结果质量检查
  - 配置不同类型问题的提示词

- [ ] **3.2.3** AI服务优化
  - 实现AI响应缓存
  - 添加备用AI服务
  - 实现响应时间监控
  - 配置成本控制机制

### ✅ 任务3.3：占卜API开发
- [ ] **3.3.1** 占卜流程API
  ```javascript
  POST /api/divination/submit
  Body: {
    question: string,
    category?: string
  }
  Response: {
    success: boolean,
    data: {
      divinationId: string,
      status: 'pending'
    }
  }

  GET /api/divination/result/:id
  Response: {
    success: boolean,
    data: {
      question: string,
      hexagram: Object,
      aiInterpretation: Object,
      createdAt: Date
    }
  }
  ```

- [ ] **3.3.2** 占卜历史API
  ```javascript
  GET /api/divination/history    // 获取历史记录
  GET /api/divination/:id        // 获取单条记录
  DELETE /api/divination/:id     // 删除记录
  POST /api/divination/:id/share // 分享记录
  ```

- [ ] **3.3.3** 占卜统计API
  ```javascript
  GET /api/divination/stats      // 用户占卜统计
  GET /api/divination/categories // 问题分类统计
  GET /api/divination/trends     // 占卜趋势分析
  ```

## 💳 第四阶段：支付系统 (Day 3上午)

### ✅ 任务4.1：支付API设计
- [ ] **4.1.1** 支付订单API
  ```javascript
  POST /api/payment/create-order
  Body: {
    packageId: string,    // 套餐ID
    paymentMethod: string // 支付方式
  }
  Response: {
    success: boolean,
    data: {
      orderId: string,
      amount: number,
      paymentUrl: string
    }
  }
  ```

- [ ] **4.1.2** 支付回调API
  ```javascript
  POST /api/payment/webhook/wechat   // 微信支付回调
  POST /api/payment/webhook/alipay   // 支付宝回调
  GET /api/payment/verify/:orderId   // 支付状态查询
  ```

- [ ] **4.1.3** 套餐管理API
  ```javascript
  GET /api/payment/packages          // 获取套餐列表
  POST /api/payment/packages         // 创建套餐(管理员)
  PUT /api/payment/packages/:id      // 更新套餐(管理员)
  ```

### ✅ 任务4.2：支付服务实现
- [ ] **4.2.1** 微信支付集成
  - 配置微信支付参数
  - 实现统一下单接口
  - 处理支付回调验证
  - 实现退款功能

- [ ] **4.2.2** 支付宝集成
  - 配置支付宝SDK
  - 实现支付接口调用
  - 处理异步通知
  - 实现订单查询

- [ ] **4.2.3** 支付安全
  - 实现签名验证
  - 添加重复支付检查
  - 配置支付超时处理
  - 实现支付日志记录

### ✅ 任务4.3：订单管理系统
- [ ] **4.3.1** 订单状态管理
  - 实现订单状态机
  - 添加状态变更日志
  - 配置自动取消机制
  - 实现订单查询接口

- [ ] **4.3.2** 次数充值逻辑
  - 实现支付成功后次数充值
  - 添加充值记录
  - 实现次数过期机制
  - 配置充值失败回滚

## 🔧 第五阶段：系统优化与监控 (Day 3下午)

### ✅ 任务5.1：性能优化
- [ ] **5.1.1** 数据库优化
  - 创建必要的数据库索引
  - 实现查询性能监控
  - 优化慢查询
  - 配置数据库连接池

- [ ] **5.1.2** 缓存策略
  - 实现热点数据缓存
  - 配置缓存更新策略
  - 实现缓存预热
  - 添加缓存命中率监控

- [ ] **5.1.3** API性能优化
  - 实现响应压缩
  - 添加请求去重
  - 优化JSON序列化
  - 实现API响应缓存

### ✅ 任务5.2：错误处理与监控
- [ ] **5.2.1** 全局错误处理
  ```javascript
  // 统一错误响应格式
  {
    success: false,
    error: {
      code: string,
      message: string,
      details?: any
    },
    timestamp: string,
    path: string
  }
  ```

- [ ] **5.2.2** 日志系统
  - 配置结构化日志
  - 实现错误日志聚合
  - 添加性能日志
  - 配置日志告警

- [ ] **5.2.3** 健康检查
  ```javascript
  GET /api/health              // 基础健康检查
  GET /api/health/detailed     // 详细健康状态
  GET /api/metrics             // 系统指标
  ```

### ✅ 任务5.3：安全加固
- [ ] **5.3.1** API安全
  - 实现请求签名验证
  - 添加IP白名单功能
  - 配置API访问限流
  - 实现敏感数据脱敏

- [ ] **5.3.2** 数据安全
  - 实现数据加密存储
  - 配置数据备份策略
  - 添加数据访问审计
  - 实现GDPR合规

## 🚀 第六阶段：部署与运维 (Beta版本)

### ✅ 任务6.1：部署配置
- [ ] **6.1.1** Docker配置
  ```dockerfile
  # Dockerfile
  FROM node:18-alpine
  WORKDIR /app
  COPY package*.json ./
  RUN npm ci --only=production
  COPY . .
  EXPOSE 3000
  CMD ["npm", "start"]
  ```

- [ ] **6.1.2** 环境配置
  - 配置生产环境变量
  - 设置数据库连接
  - 配置第三方服务密钥
  - 实现配置热更新

- [ ] **6.1.3** Sealos DevBox部署
  - 配置部署脚本
  - 设置自动化部署
  - 配置负载均衡
  - 实现蓝绿部署

### ✅ 任务6.2：监控告警
- [ ] **6.2.1** 应用监控
  - 配置APM监控
  - 实现错误率监控
  - 添加响应时间监控
  - 配置内存使用监控

- [ ] **6.2.2** 业务监控
  - 监控用户注册量
  - 监控占卜成功率
  - 监控支付成功率
  - 监控AI服务调用

- [ ] **6.2.3** 告警配置
  - 配置错误率告警
  - 设置响应时间告警
  - 添加服务可用性告警
  - 实现告警通知

## 📊 验收标准

### 功能验收标准
- [ ] 用户注册登录API成功率 > 99%
- [ ] 占卜算法准确性验证通过
- [ ] AI解读生成成功率 > 95%
- [ ] 支付接口调用成功率 > 98%
- [ ] API响应时间 < 2秒

### 性能验收标准
- [ ] 数据库查询响应时间 < 100ms
- [ ] 缓存命中率 > 80%
- [ ] 并发处理能力 > 1000 QPS
- [ ] 内存使用 < 512MB
- [ ] CPU使用率 < 70%

### 安全验收标准
- [ ] 所有API接口认证验证
- [ ] 敏感数据加密存储
- [ ] SQL注入防护测试通过
- [ ] XSS攻击防护测试通过
- [ ] 请求限流机制有效

## 🔄 后续迭代计划

### v1.0版本功能
- 邀请系统API
- 会员系统API
- 数据分析API
- 管理后台API

### v1.5版本功能
- 微服务架构拆分
- 消息队列优化
- 分布式缓存
- 数据库分库分表

---

**文档版本**: v1.0  
**创建日期**: 2025-07-26  
**负责人**: 后端开发团队  
**预计完成时间**: 3天MVP + 2周Beta版本
